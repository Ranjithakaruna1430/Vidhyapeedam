<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vidhyapeedam Tracker</title>

<style>
  :root{--accent:#7b2fa0;--bg:#fff8fb}
  body{font-family:system-ui,Arial; background:linear-gradient(180deg,var(--bg),#fff); margin:0; min-height:100vh; display:flex;align-items:center;justify-content:center;padding:18px;color:#40332b}
  .card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.06);width:380px;max-width:96%}
  h1{margin:0 0 12px;color:var(--accent)}
  input, button, select{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #eae0df;font-size:15px}
  button{background:var(--accent);color:#fff;border:none;cursor:pointer}
  .small{font-size:13px;color:#6b5648;margin-top:6px}
  .debug{margin-top:10px;padding:8px;border-radius:8px;background:#fff7f7;color:#7a2a2a;font-size:13px}
  .status{font-size:13px;margin-top:6px}
</style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // ---------- Your Firebase configuration (from you) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyAo9fjlWFSnUgBZQIubh5bGoIyoFBDg1h8",
    authDomain: "vidyapeedam.firebaseapp.com",
    databaseURL: "https://vidyapeedam-default-rtdb.firebaseio.com",
    projectId: "vidyapeedam",
    storageBucket: "vidyapeedam.appspot.com",
    messagingSenderId: "883726093815",
    appId: "1:883726093815:web:44b8bd52b14942ee5ef2f2",
    measurementId: "G-8ZWRBXCM52"
  };

  // small helper to write debug messages to page and console
  function debugLog(msg){
    console.log('[VPT]', msg);
    const el = document.getElementById('debugArea');
    if(el) el.textContent = msg;
  }

  function showError(e){
    console.error(e);
    const el = document.getElementById('debugArea');
    if(el) el.textContent = 'Error: ' + (e && e.message ? e.message : String(e));
    alert('Error: ' + (e && e.message ? e.message : String(e)));
  }

  // Initialize Firebase (wrapped in try/catch)
  let app, db;
  try{
    app = initializeApp(firebaseConfig);
    db = getDatabase(app);
    debugLog('Firebase initialized âœ“');
  }catch(err){
    showError(err);
  }

  // sanitize user-entered name into DB key (avoid / . # $ [ ] characters)
  function keyFromName(name){
    // normalize, remove extra spaces, replace forbidden chars with underscore
    return encodeURIComponent(name.trim().toLowerCase().replace(/[.#$\/\[\]]/g, '_'));
  }

  // saveData with robust logs & error handling
  window.saveData = async function(){
    try{
      debugLog('Save clicked â€” starting...');
      const name = document.getElementById('name').value.trim();
      const date = document.getElementById('date').value;
      const countRaw = document.getElementById('count').value;
      const count = Number(countRaw);

      if(!name){
        alert('Please enter Name');
        return;
      }
      if(!date){
        alert('Please choose a Date');
        return;
      }
      if(!countRaw || !Number.isFinite(count) || count < 0){
        alert('Please enter a valid number for Count (0 or greater).');
        return;
      }

      const key = keyFromName(name);
      debugLog(`Resolved key: ${key}`);

      const userRef = ref(db, 'users/' + key);

      debugLog('Fetching previous total...');
      const snapshot = await get(userRef);
      let previousTotal = 0;
      if(snapshot.exists()){
        previousTotal = Number(snapshot.val().totalCount || 0);
        debugLog('Previous total for ' + name + ' = ' + previousTotal);
      } else {
        debugLog('No previous record for ' + name + ', will create new.');
      }

      const newTotal = previousTotal + count;
      debugLog('New total = ' + newTotal);

      await set(userRef, {
        name: name,
        lastDate: date,
        lastCount: count,
        totalCount: newTotal
      });

      debugLog('Saved to DB successfully.');
      document.getElementById('userTotal').innerText = newTotal;
      updateGroupTotal(); // refresh group
      // small visual success message
      const s = document.getElementById('savedMsg');
      if(s){ s.textContent = 'Saved âœ“'; setTimeout(()=>s.textContent = '', 1200); }
    }catch(err){
      showError(err);
    }
  };

  // live group total listener
  function updateGroupTotal(){
    try{
      const usersRef = ref(db, 'users');
      onValue(usersRef, (snapshot) => {
        let group = 0;
        snapshot.forEach(child => {
          group += Number(child.val().totalCount || 0);
        });
        document.getElementById('groupTotal').innerText = group;
        debugLog('Group total updated: ' + group);
      }, err => {
        showError(err);
      });
    }catch(err){
      showError(err);
    }
  }

  // load a user's total (for preview when name typed)
  window.loadUserTotal = async function(){
    try{
      const name = document.getElementById('name').value.trim();
      if(!name){ document.getElementById('userTotal').innerText = 'â€”'; return; }
      const key = keyFromName(name);
      const snapshot = await get(ref(db, 'users/' + key));
      if(snapshot.exists()){
        document.getElementById('userTotal').innerText = snapshot.val().totalCount || 0;
      } else {
        document.getElementById('userTotal').innerText = 0;
      }
    }catch(err){
      showError(err);
    }
  };

  window.addEventListener('load', () => {
    // default today
    const d = new Date().toISOString().slice(0,10);
    const dateEl = document.getElementById('date'); if(dateEl) dateEl.value = d;
    try{
      updateGroupTotal();
    }catch(e){
      showError(e);
    }
  });
</script>
</head>
<body>
  <div class="card">
    <h1>ðŸª” Vidhyapeedam Tracker</h1>

    <div class="small">Name</div>
    <input id="name" type="text" placeholder="Enter your name (English or Tamil)" onblur="loadUserTotal()">

    <div style="display:flex;gap:8px;margin-top:6px">
      <div style="flex:1">
        <div class="small">Date</div>
        <input id="date" type="date">
      </div>
      <div style="width:130px">
        <div class="small">Enter the count</div>
        <input id="count" type="number" min="0" placeholder="e.g. 108">
      </div>
    </div>

    <button style="margin-top:12px" onclick="saveData()">Save</button>
    <div style="height:22px;margin-top:6px;color:green;font-weight:600" id="savedMsg"></div>

    <div style="margin-top:12px" class="small">User Total Count: <span id="userTotal">â€”</span></div>
    <div class="small">Group Total Count: <span id="groupTotal">0</span></div>

    <div class="debug" id="debugArea" role="status" aria-live="polite">Status: waiting...</div>
  </div>
</body>
</html>
