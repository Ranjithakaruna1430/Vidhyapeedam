<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vidhyapeedam Tracker</title>

<!-- Firebase + app logic loaded as ES module -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

 // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAo9fjlWFSnUgBZQIubh5bGoIyoFBDg1h8",
  authDomain: "vidyapeedam.firebaseapp.com",
  databaseURL: "https://vidyapeedam-default-rtdb.firebaseio.com",
  projectId: "vidyapeedam",
  storageBucket: "vidyapeedam.firebasestorage.app",
  messagingSenderId: "883726093815",
  appId: "1:883726093815:web:44b8bd52b14942ee5ef2f2",
  measurementId: "G-8ZWRBXCM52"
};
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DB_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MSG_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Utility: sanitize name to use as key (replace dots and slashes)
  function keyFromName(name){
    return encodeURIComponent(name.trim().toLowerCase().replaceAll('.', '_'));
  }

  // Save the user's count (adds to user's total)
  window.saveData = async function(){
    const nameEl = document.getElementById('name');
    const dateEl = document.getElementById('date');
    const countEl = document.getElementById('count');
    const name = nameEl.value.trim();
    const date = dateEl.value;
    const count = Number(countEl.value);

    if(!name || !date || !Number.isFinite(count) || count < 0){
      alert('Please enter Name, Date and a valid count (0 or greater).');
      return;
    }

    const key = keyFromName(name);
    const userRef = ref(db, 'users/' + key);

    // fetch current total
    const snap = await get(userRef);
    let prevTotal = 0;
    if(snap.exists()){
      prevTotal = Number(snap.val().totalCount || 0);
    }

    const newTotal = prevTotal + count;

    // save updated user record
    await set(userRef, {
      name: name,
      lastDate: date,
      lastCount: count,
      totalCount: newTotal
    });

    // update displayed totals immediately
    document.getElementById('userTotal').innerText = newTotal;
    // clear only the count input for convenience
    countEl.value = '';
    // Update the group total display (onValue listener also keeps this updated)
    alert('Saved successfully!');
  };

  // Live update group total and (optionally) show selected user's total
  function startRealtimeListeners(){
    const usersRef = ref(db, 'users');
    // When the database under 'users' changes, recalc group total
    onValue(usersRef, (snapshot) => {
      let groupTotal = 0;
      const usersList = [];
      snapshot.forEach(childSnap => {
        const u = childSnap.val();
        const t = Number(u.totalCount || 0);
        groupTotal += t;
        usersList.push({ key: childSnap.key, name: u.name, total: t });
      });
      document.getElementById('groupTotal').innerText = groupTotal;

      // update the small dropdown of users so viewers can check individual totals
      const sel = document.getElementById('userSelect');
      if(sel){
        // remember current selection
        const cur = sel.value;
        sel.innerHTML = '<option value="">-- Select user (optional) --</option>' +
          usersList.map(u => `<option value="${u.key}">${escapeHtml(u.name)}</option>`).join('');
        // restore selection if possible
        if(cur) sel.value = cur;
      }
    });
  }

  // When user selects someone in the dropdown, show their total immediately
  window.onUserSelected = async function(){
    const sel = document.getElementById('userSelect');
    const key = sel.value;
    if(!key){
      document.getElementById('userTotal').innerText = 'â€”';
      return;
    }
    const s = await get(ref(db, 'users/' + key));
    if(s.exists()){
      document.getElementById('userTotal').innerText = s.val().totalCount || 0;
    } else {
      document.getElementById('userTotal').innerText = 0;
    }
  };

  function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // Start realtime listeners once window loads
  window.addEventListener('load', () => {
    // set default date to today
    const dateEl = document.getElementById('date');
    if(dateEl) dateEl.value = new Date().toISOString().slice(0,10);
    startRealtimeListeners();
  });
</script>

<style>
  :root{ --accent:#7b2fa0; --bg1:#fff6f9; --card:#ffffff;}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto; background:linear-gradient(180deg,var(--bg1),#fff);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;color:#40332b}
  .card{background:var(--card);padding:22px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.06);width:360px;max-width:95%}
  h1{margin:0 0 12px;color:var(--accent);font-size:20px;text-align:center}
  input, button, select{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #e9e1dd;font-size:15px}
  button{background:var(--accent);color:#fff;border:none;font-weight:600;cursor:pointer}
  .totals{margin-top:12px;font-weight:600}
  .small{font-weight:500;color:#6b5648;font-size:13px}
  .row{display:flex;gap:8px}
  @media(min-width:600px){ .row > *{flex:1} }
</style>
</head>
<body>
  <div class="card">
    <h1>ðŸª” Vidhyapeedam Tracker</h1>

    <div class="small">Name</div>
    <input id="name" type="text" placeholder="Enter your name (English or Tamil)">

    <div class="row" style="margin-top:6px">
      <div style="flex:1">
        <div class="small">Date</div>
        <input id="date" type="date">
      </div>
      <div style="width:130px">
        <div class="small">Enter the count</div>
        <input id="count" type="number" min="0" placeholder="e.g. 108">
      </div>
    </div>

    <button style="margin-top:12px" onclick="saveData()">Save</button>

    <div class="totals">
      <div style="margin-top:10px" class="small">User Total Count: <span id="userTotal">â€”</span></div>
      <div style="margin-top:6px" class="small">Group Total Count: <span id="groupTotal">0</span></div>
    </div>

    <div style="margin-top:10px">
      <select id="userSelect" onchange="onUserSelected()">
        <option value="">-- Select user (optional) --</option>
      </select>
    </div>
  </div>
</body>
</html>
